{% extends "employee_base.html" %}

{% block title %}{{ course.title }} - Training NIS2{% endblock %}

{% block page_title %}{{ course.title }}{% endblock %}

{% block breadcrumb %}
<span class="text-secondary">/ Training NIS2</span>
<span class="text-secondary">/ I Miei Corsi</span>
<span class="text-secondary">/ {{ course.title }}</span>
{% endblock %}

{% block extra_css %}
<style>
    .course-header {
        background: var(--gradient-primary);
        color: white;
        padding: 2rem;
        border-radius: var(--border-radius-lg);
        margin-bottom: 2rem;
    }
    
    .course-meta {
        display: flex;
        gap: 2rem;
        margin-top: 1rem;
        flex-wrap: wrap;
    }
    
    .meta-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
    }
    
    .progress-section {
        background: white;
        padding: 1.5rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        margin-bottom: 2rem;
    }
    
    .progress-bar {
        width: 100%;
        height: 12px;
        background: #e2e8f0;
        border-radius: 6px;
        overflow: hidden;
        margin: 1rem 0;
    }
    
    .progress-fill {
        height: 100%;
        background: var(--gradient-success);
        transition: width 0.3s ease;
    }
    
    .content-section {
        background: white;
        padding: 1.5rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        margin-bottom: 2rem;
    }
    
    .content-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        border: 1px solid #e2e8f0;
        border-radius: var(--border-radius);
        margin-bottom: 0.5rem;
        transition: var(--transition-fast);
        cursor: pointer;
    }
    
    .content-item:hover {
        background: #f8fafc;
        border-color: var(--primary-blue);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .content-item.completed {
        background: #dcfce7;
        border-color: #22c55e;
    }
    
         .content-item.current {
         background: #dbeafe;
         border-color: #3b82f6;
         box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
     }
     
     .content-icon {
         width: 40px;
         height: 40px;
         background: var(--gradient-primary);
         border-radius: 50%;
         display: flex;
         align-items: center;
         justify-content: center;
         color: white;
         font-size: 1.125rem;
     }
     
     .content-info {
         flex: 1;
     }
     
     .content-title {
         font-weight: 600;
         color: var(--primary-blue);
         margin-bottom: 0.25rem;
     }
     
     .content-duration {
         font-size: 0.875rem;
         color: var(--secondary-gray);
     }
     
     .content-status {
         padding: 0.25rem 0.75rem;
         border-radius: 9999px;
         font-size: 0.75rem;
         font-weight: 500;
     }
     
     .status-pending {
         background: #fef3c7;
         color: #92400e;
     }
     
     .status-completed {
         background: #dcfce7;
         color: #166534;
     }
    
         .video-player {
         width: 100%;
         max-width: 800px;
         margin: 1rem auto;
         border-radius: var(--border-radius);
         overflow: hidden;
         box-shadow: var(--shadow-md);
     }
    
    .video-container {
        position: relative;
        width: 100%;
        height: 0;
        padding-bottom: 56.25%; /* 16:9 aspect ratio */
    }
    
    .video-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: var(--border-radius);
    }
    
         .content-detail {
         background: white;
         padding: 2rem;
         border-radius: var(--border-radius-lg);
         box-shadow: var(--shadow-md);
         margin: 1rem 0;
         display: none;
     }
    
    
    
         .content-text {
         line-height: 1.6;
         color: var(--secondary-gray);
     }
     
     .content-text h3, .content-text h4 {
         color: var(--primary-blue);
         margin: 1.5rem 0 0.5rem 0;
     }
     
     .content-text ul {
         margin: 0.5rem 0;
         padding-left: 1.5rem;
     }
     
     .content-text p {
         margin: 0.5rem 0;
     }
    
    
    
    
    
    
    
    .content-text table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
    }
    
    .content-text th, .content-text td {
        border: 1px solid #d1d5db;
        padding: 0.5rem;
        text-align: left;
    }
    
    .content-text th {
        background: #f3f4f6;
        font-weight: 600;
    }
    
    .quiz-section {
        background: white;
        padding: 1.5rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        margin-bottom: 2rem;
    }
    
    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: var(--border-radius);
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition-fast);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
    }
    
    .btn-primary {
        background: var(--gradient-primary);
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }
    
    .btn-success {
        background: var(--gradient-success);
        color: white;
    }
    
    .btn-success:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }
    
    .btn-secondary {
        background: var(--gradient-secondary);
        color: var(--primary-blue);
    }
    
    .btn-secondary:hover {
        background: var(--primary-blue);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
{% if error %}
<div class="alert alert-danger">
    <i class="fas fa-exclamation-triangle"></i>
    Errore: {{ error }}
</div>
{% endif %}

<!-- Header del Corso -->
<div class="course-header">
    <h1>{{ course.title }}</h1>
    <p>{{ course.description }}</p>
    
    <div class="course-meta">
        <div class="meta-item">
            <i class="fas fa-clock"></i>
            <span>{{ course.duration_minutes }} minuti</span>
        </div>
        <div class="meta-item">
            <i class="fas fa-signal"></i>
            <span>{{ course.difficulty_level }}</span>
        </div>
        <div class="meta-item">
            <i class="fas fa-tag"></i>
            <span>{{ course.category }}</span>
        </div>
        <div class="meta-item">
            <i class="fas fa-calendar"></i>
            <span>Iscritto il {{ enrollment.enrollment_date }}</span>
        </div>
    </div>
</div>

<!-- Sezione Progresso -->
<div class="progress-section">
    <h3><i class="fas fa-chart-line"></i> Progresso Corso</h3>
    
    <div class="progress-bar">
        <div class="progress-fill" style="width: {{ progress }}%"></div>
    </div>
    
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <span>{{ progress }}% completato</span>
        <span>{{ completed_modules }}/{{ total_modules }} moduli completati</span>
    </div>
    
    {% if progress == 100 %}
    <div style="margin-top: 1rem; padding: 1rem; background: #dcfce7; border-radius: var(--border-radius);">
        <i class="fas fa-trophy"></i>
        <strong>Congratulazioni! Hai completato il corso!</strong>
    </div>
    {% endif %}
</div>

<!-- Sezione Contenuti -->
<div class="content-section">
    <h3><i class="fas fa-book"></i> Contenuti del Corso</h3>
    
    {% if course_contents %}
        {% for content in course_contents %}
                 <div class="content-item {% if loop.index <= completed_modules %}completed{% elif loop.index == completed_modules + 1 %}current{% endif %}" 
              data-content-id="{{ content.id }}" 
              data-content-type="{{ content.content_type }}"
              onclick="showContent({{ content.id }})">
            <div class="content-icon">
                {% if content.content_type == 'VIDEO' %}
                    <i class="fas fa-video"></i>
                {% elif content.content_type == 'LESSON' %}
                    <i class="fas fa-play"></i>
                {% elif content.content_type == 'MODULE' %}
                    <i class="fas fa-cube"></i>
                {% elif content.content_type == 'DOCUMENT' %}
                    <i class="fas fa-file-pdf"></i>
                {% else %}
                    <i class="fas fa-file-alt"></i>
                {% endif %}
            </div>
            <div class="content-info">
                <div class="content-title">{{ content.title }}</div>
                <div class="content-duration">
                    {% if content.duration_minutes %}
                        {{ content.duration_minutes }} minuti
                    {% else %}
                        Contenuto
                    {% endif %}
                </div>
            </div>
            <span class="content-status {% if loop.index <= completed_modules %}status-completed{% else %}status-pending{% endif %}">
                {% if loop.index <= completed_modules %}
                    Completato
                {% else %}
                    In attesa
                {% endif %}
            </span>
        </div>
        
        <!-- Dettaglio contenuto -->
        <div id="content-detail-{{ content.id }}" class="content-detail">
            <h3>{{ content.title }}</h3>
            
                         {% if content.content_type == 'VIDEO' %}
                 <!-- Il video è già embedded nel contenuto HTML -->
             {% endif %}
            
            <div class="content-text">
                {{ content.content|safe }}
            </div>
            
            <div style="margin-top: 2rem; text-align: center;">
                <button class="btn btn-success" onclick="markAsCompleted({{ content.id }})">
                    <i class="fas fa-check"></i>
                    Segna come Completato
                </button>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div style="text-align: center; padding: 2rem; color: var(--secondary-gray);">
            <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
            <p>Nessun contenuto disponibile per questo corso.</p>
        </div>
    {% endif %}
</div>

<!-- Sezione Quiz -->
<div class="quiz-section">
    <h3><i class="fas fa-question-circle"></i> Quiz di Valutazione</h3>
    
    {% if quiz %}
    <p>Test finale per verificare la comprensione del corso.</p>
    
    <div style="margin: 1rem 0;">
        <strong>Punteggio minimo:</strong> {{ quiz.passing_score }}%<br>
        <strong>Tempo limite:</strong> {{ quiz.time_limit_minutes }} minuti<br>
        <strong>Domande:</strong> {{ quiz.questions|length }}
    </div>
    
    {% if progress == 100 %}
        {% if enrollment.score %}
        <div style="margin: 1rem 0; padding: 1rem; background: #dcfce7; border-radius: var(--border-radius);">
            <i class="fas fa-check-circle"></i>
            <strong>Quiz completato!</strong> Punteggio: {{ enrollment.score }}%
        </div>
        {% else %}
        <a href="/training/quiz/{{ enrollment.enrollment_id }}" class="btn btn-primary">
            <i class="fas fa-play"></i>
            Inizia Quiz
        </a>
        {% endif %}
    {% else %}
    <div style="margin: 1rem 0; padding: 1rem; background: #fef3c7; border-radius: var(--border-radius);">
        <i class="fas fa-info-circle"></i>
        Completa tutti i contenuti del corso per accedere al quiz.
    </div>
    {% endif %}
    
    {% else %}
    <p>Nessun quiz disponibile per questo corso.</p>
    {% endif %}
</div>

<!-- Azioni -->
<div style="display: flex; gap: 1rem; justify-content: center;">
    <a href="/training/employee-courses" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i>
        Torna ai Miei Corsi
    </a>
    
    {% if progress < 100 %}
    <button class="btn btn-primary" onclick="continueCourse()">
        <i class="fas fa-play"></i>
        Continua Corso
    </button>
    {% endif %}
    
    {% if progress == 100 and enrollment.score and enrollment.score >= quiz.passing_score %}
    <button class="btn btn-success" onclick="downloadCertificate()">
        <i class="fas fa-certificate"></i>
        Scarica Certificato
    </button>
    {% endif %}
</div>
 {% endblock %}
 
 {% block extra_js %}
 <script>
     console.log('SCRIPT INIZIALIZZATO');
     
     let currentContentId = null;
     
     // Test per verificare che il JavaScript sia caricato
     console.log('JavaScript caricato correttamente');
     
     // Test per verificare che gli elementi esistano
     document.addEventListener('DOMContentLoaded', function() {
         console.log('DOM caricato');
         const contentItems = document.querySelectorAll('.content-item');
         console.log('Elementi contenuto trovati:', contentItems.length);
         
         contentItems.forEach((item, index) => {
             console.log(`Elemento ${index}:`, item);
         });
     });
     
     function showContent(contentId) {
         console.log('showContent chiamata con:', contentId);
         
         // Nascondi tutti i dettagli contenuto
         document.querySelectorAll('.content-detail').forEach(detail => {
             detail.style.display = 'none';
         });
         
         // Rimuovi la classe current da tutti gli elementi
         document.querySelectorAll('.content-item').forEach(item => {
             item.classList.remove('current');
         });
         
         // Aggiungi la classe current all'elemento cliccato
         const clickedItem = event.currentTarget;
         clickedItem.classList.add('current');
         
         // Mostra il dettaglio del contenuto selezionato
         const detailElement = document.getElementById(`content-detail-${contentId}`);
         console.log('Elemento trovato:', detailElement);
         
         if (detailElement) {
             detailElement.style.display = 'block';
             currentContentId = contentId;
             
             // Scroll al contenuto
             detailElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
             console.log('Contenuto mostrato con successo');
         } else {
             console.error('Elemento non trovato per ID:', `content-detail-${contentId}`);
         }
     }
     
     function markAsCompleted(contentId) {
         // Per ora, mostra un messaggio di successo
         alert('Contenuto segnato come completato!');
         
         // In futuro, qui si farà una chiamata API per aggiornare il progresso
         // fetch('/training/api/mark-completed', {
         //     method: 'POST',
         //     headers: { 'Content-Type': 'application/json' },
         //     body: JSON.stringify({ content_id: contentId })
         // });
     }
     
     function continueCourse() {
         // Trova il prossimo contenuto non completato
         const nextContent = document.querySelector('.content-item:not(.completed)');
         if (nextContent) {
             nextContent.click();
         }
     }
     
     function downloadCertificate() {
         // Per ora, mostra un messaggio
         alert('Certificato scaricato!');
         
         // In futuro, qui si farà il download del certificato
         // window.open('/training/certificate/download', '_blank');
     }
 </script>
 {% endblock %}
